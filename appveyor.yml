version: ci.{build}
image: Visual Studio 2017
clone_depth: 1
init:
# Setup QT 5.12 - 64Bit

- set QTDIR=C:\Qt\5.12\msvc2017_64
- set PATH=%QTDIR%\bin;%PATH%

# Setup MSVC - VS 2017

- call c:\"Program Files (x86)"\"Microsoft Visual Studio"\2017\Community\VC\Auxiliary\Build\vcvarsall.bat amd64

# Get the libraries

- ps: Start-FileDownload 'https://github.com/GoldenCheetah/WindowsSDK/releases/download/v0.1.1/gc-ci-libs.zip' -Filename 'c:/gc-ci-libs.zip'
- 7z x c:/gc-ci-libs.zip -oC:\libs

install:
# choco install winflexbison
- copy qwt\qwtconfig.pri.in qwt\qwtconfig.pri
- copy c:\libs\gcconfig64-Release.appveyor.pri src\gcconfig.pri

# Get jom
- ps: Start-FileDownload 'https://download.qt.io/official_releases/jom/jom_1_1_3.zip'
- 7z x jom_1_1_3.zip -oc:\jom\
- set PATH=%PATH%;c:\jom\;

# Get R and add to config
- ps: $rurl = $(ConvertFrom-JSON $(Invoke-WebRequest https://rversions.r-pkg.org/r-release-win).Content).URL
- ps: Start-FileDownload $rurl "R-win.exe"
- ps: Start-Process -FilePath .\R-win.exe -ArgumentList "/VERYSILENT /DIR=C:\R" -NoNewWindow -Wait
- set PATH=%PATH%;c:\R\bin\;
- R --version
- echo DEFINES+=GC_WANT_R >> src\gcconfig.pri

# Get SIP and add Python to config
- c:\python36-x64\python --version
- ps: Start-FileDownload https://sourceforge.net/projects/pyqt/files/sip/sip-4.19.8/sip-4.19.8.zip
- 7z x sip-4.19.8.zip
- ps: cd sip-4.19.8
- c:\python36-x64\python configure.py
- jom -j4
- nmake install
- ps: cd ..
- echo DEFINES+=GC_WANT_PYTHON >> src\gcconfig.pri
- echo PYTHONINCLUDES=-I\"c:\python36-x64\include\" >> src\gcconfig.pri
- echo PYTHONLIBS=-L\"c:\python36-x64\libs\" -lpython36 >> src\gcconfig.pri

build_script:
- qmake.exe build.pro -r -spec win32-msvc
- jom -j4
- cd src\release
# copy dependencies
- windeployqt --release GoldenCheetah.exe
- copy c:\libs\10_Precompiled_DLL\usbexpress_3.5.1\USBXpress\USBXpress_API\Host\x64\SiUSBXp.dll
- copy c:\libs\10_Precompiled_DLL\libsamplerate64\lib\libsamplerate-0.dll
- copy c:\libs\10_Precompiled_DLL\VLC\win64\lib\libvlc*.dll
- copy c:\OpenSSL-v111-Win64\bin\lib*.dll
- copy c:\python36-x64\python36.dll
# minimum test
- GoldenCheetah --version
# cleanup
- del *.h *.cpp *.obj *.pdb *.res
# pack and upload to transfer.sh
- 7z a GoldenCheetah.zip *
- curl --upload-file GoldenCheetah.zip https://transfer.sh/GoldenCheetah.zip
- cd ..\..

#notifications:
#- provider: GitHubPullRequest
#  on_build_success: true
#  on_build_failure: true
#  on_build_status_changed: true
